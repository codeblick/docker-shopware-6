version: 2.1

jobs:
  setup:
    machine: true
    steps:
      - checkout
      - run: echo "$DOCKER_PASS" | docker login --username $DOCKER_USER --password-stdin
      - run: docker buildx create --use

  build:
    machine: true
    parameters:
      php_version:
        type: string
      node_version:
        type: string
      with_xdebug:
        type: string
    steps:
      - checkout
      - run: |
          TAG="php-$<< parameters.php_version >>$([ $<< parameters.with_xdebug >> == '1' ] && echo '-xdebug' || echo '')"
          docker buildx build --platform linux/amd64,linux/arm64 \
            -t codeblick/shopware-6:$TAG \
            --build-arg PHP_VERSION=$<< parameters.php_version >> \
            --build-arg NODE_VERSION=$<< parameters.node_version >> \
            --build-arg WITH_XDEBUG=$<< parameters.with_xdebug >> \
            --push .

workflows:
  version: 2
  build_and_push:
    jobs:
      - setup
      - build:
          name: build_php_84
          php_version: "8.4"
          node_version: "20.12.0"
          with_xdebug: "0"
          requires:
            - setup
      - build:
          name: build_php_84_xdebug
          php_version: "8.4"
          node_version: "20.12.0"
          with_xdebug: "1"
          requires:
            - setup
      - build:
          name: build_php_83
          php_version: "8.3"
          node_version: "20.12.0"
          with_xdebug: "0"
          requires:
            - setup
      - build:
          name: build_php_83_xdebug
          php_version: "8.3"
          node_version: "20.12.0"
          with_xdebug: "1"
          requires:
            - setup
      - build:
          name: build_php_82
          php_version: "8.2"
          node_version: "18.20.0"
          with_xdebug: "0"
          requires:
            - setup
      - build:
          name: build_php_82_xdebug
          php_version: "8.2"
          node_version: "18.20.0"
          with_xdebug: "1"
          requires:
            - setup
    filters:
      branches:
        only:
          - main
